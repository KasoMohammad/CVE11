const mongoose = require('mongoose');

const descriptionSchema = new mongoose.Schema({
  lang: String,
  value: String,
});

const cvssDataSchema = new mongoose.Schema({
  baseSeverity: String,
  exploitabilityScore: Number,
  impactScore: Number,
});

const weaknessSchema = new mongoose.Schema({
  source: String,
  type: String,
  description: [descriptionSchema],
});

const cpeMatchSchema = new mongoose.Schema({
  vulnerable: Boolean,
  criteria: String,
  matchCriteriaId: String,
});

const nodeSchema = new mongoose.Schema({
  operator: String,
  negate: Boolean,
  cpeMatch: [cpeMatchSchema],
});

const configurationSchema = new mongoose.Schema({
  nodes: [nodeSchema],
});

const cveSchema = new mongoose.Schema({
  id: String,
  sourceIdentifier: String,
  published: Date,
  lastModified: Date,
  vulnStatus: String,
  descriptions: [descriptionSchema],
  metrics: {
    cvssMetricV2: [cvssDataSchema],
  },
  weaknesses: [weaknessSchema],
  configurations: [configurationSchema],
  references: [String],
  assets: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Asset' }], // Verknüpfung zu Assets
});

// Index auf das Veröffentlichungsdatum setzen
cveSchema.index({ published: -1 });

const CVE = mongoose.model('CVE', cveSchema);

module.exports = CVE;
